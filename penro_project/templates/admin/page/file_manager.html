{% extends "admin/layout/base.html" %}
{% block title %}File Manager{% endblock %}
{% block page_title %}File Manager{% endblock %}

{% block content %}

<!-- Breadcrumb Navigation -->
<nav class="fm-breadcrumb">
  <a href="{% url 'admin_app:file-manager' %}" class="fm-crumb-link">
    <i class="fas fa-home"></i>
  </a>
  
  {% if breadcrumb|length > 4 %}
    <i class="fas fa-chevron-right text-muted mx-2"></i>
    <div class="dropdown">
      <button class="btn btn-sm btn-link dropdown-toggle text-muted" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-ellipsis-h"></i>
      </button>
      <ul class="dropdown-menu">
        {% for folder in breadcrumb %}
          {% if forloop.counter > 1 and forloop.counter < breadcrumb|length|add:"-1" %}
          <li>
            <a class="dropdown-item folder-dropzone" 
               href="{% url 'admin_app:file-manager-folder' folder.id %}"
               data-folder-id="{{ folder.id }}"
               data-folder-type="{{ folder.folder_type }}"
               data-folder-name="{{ folder.name }}">
              <i class="fas fa-folder text-primary me-2"></i>{{ folder.name }}
            </a>
          </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
    
    {% with breadcrumb|slice:"-2:" as last_items %}
      {% for folder in last_items %}
        <i class="fas fa-chevron-right text-muted mx-2"></i>
        {% if not forloop.last %}
          <a href="{% url 'admin_app:file-manager-folder' folder.id %}" 
             class="fm-crumb-link folder-dropzone"
             data-folder-id="{{ folder.id }}"
             data-folder-type="{{ folder.folder_type }}"
             data-folder-name="{{ folder.name }}">
            <i class="fas fa-folder text-primary me-1"></i>{{ folder.name }}
          </a>
        {% else %}
          <span class="fm-crumb-current">
            <i class="fas fa-folder-open text-primary me-1"></i>{{ folder.name }}
          </span>
        {% endif %}
      {% endfor %}
    {% endwith %}
  {% else %}
    {% for folder in breadcrumb %}
      {% if not forloop.first %}
        <i class="fas fa-chevron-right text-muted mx-2"></i>
        {% if not forloop.last %}
          <a href="{% url 'admin_app:file-manager-folder' folder.id %}" 
             class="fm-crumb-link folder-dropzone"
             data-folder-id="{{ folder.id }}"
             data-folder-type="{{ folder.folder_type }}"
             data-folder-name="{{ folder.name }}">
            <i class="fas fa-folder text-primary me-1"></i>{{ folder.name }}
          </a>
        {% else %}
          <span class="fm-crumb-current">
            <i class="fas fa-folder-open text-primary me-1"></i>{{ folder.name }}
          </span>
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
</nav>

<!-- Toolbar -->
<div class="fm-toolbar">
  <div class="d-flex gap-2">
    <button class="btn btn-primary btn-sm" onclick="document.getElementById('fileUpload').click()">
      <i class="fas fa-upload me-1"></i>Upload Files
    </button>
    <button class="btn btn-outline-primary btn-sm" onclick="showCreateFolderModal()">
      <i class="fas fa-folder-plus me-1"></i>New Folder
    </button>
  </div>
  
  <form id="uploadForm" method="post" enctype="multipart/form-data" 
        action="{% url 'admin_app:upload-files' %}" style="display:none">
    {% csrf_token %}
    <input type="hidden" name="folder_id" value="{{ current_folder.id }}">
    <input type="file" id="fileUpload" name="files" multiple onchange="handleFileUpload(event)">
  </form>
</div>

<!-- File Grid -->
<div class="fm-grid">
  {% for f in folders %}
  <div class="fm-card folder-dropzone {% if not f.is_system_generated %}draggable-folder{% endif %}"
       data-folder-id="{{ f.id }}"
       data-folder-type="{{ f.folder_type }}"
       data-folder-name="{{ f.name }}"
       data-is-system="{{ f.is_system_generated|lower }}"
       {% if not f.is_system_generated %}draggable="true"{% endif %}>
    
    <div class="fm-card-menu" onclick="showFolderMenu(event, '{{ f.id }}', '{{ f.name }}', {{ f.is_system_generated|lower }})">
      <i class="fas fa-ellipsis-v"></i>
    </div>
    
    <a href="{% url 'admin_app:file-manager-folder' f.id %}" class="fm-card-link">
      <div class="fm-card-icon">
        <i class="fas fa-folder {% if f.is_system_generated %}text-primary{% else %}text-warning{% endif %}"></i>
      </div>
      <div class="fm-card-name" title="{{ f.name }}">{{ f.name }}</div>
      <div class="fm-card-meta">
        {% if f.is_system_generated %}<i class="fas fa-lock me-1"></i>System{% else %}Folder{% endif %}
      </div>
    </a>
  </div>
  {% endfor %}

  {% for a in attachments %}
  <div class="fm-card draggable-file"
       draggable="true"
       data-attachment-id="{{ a.id }}"
       data-file-name="{{ a.file.name|cut:'work_items/' }}">
    
    <div class="fm-card-menu" onclick="showFileMenu(event, '{{ a.id }}', '{{ a.file.name|cut:'work_items/' }}')">
      <i class="fas fa-ellipsis-v"></i>
    </div>
    
    <div class="fm-card-link">
      <div class="fm-card-icon">
        {% if a.file.name|slice:"-4:" == ".pdf" %}
          <i class="fas fa-file-pdf text-danger"></i>
        {% elif a.file.name|slice:"-5:" == ".docx" or a.file.name|slice:"-4:" == ".doc" %}
          <i class="fas fa-file-word text-primary"></i>
        {% elif a.file.name|slice:"-5:" == ".xlsx" or a.file.name|slice:"-4:" == ".xls" %}
          <i class="fas fa-file-excel text-success"></i>
        {% elif a.file.name|slice:"-4:" in ".jpg.png.gif.jpeg" %}
          <i class="fas fa-file-image text-info"></i>
        {% else %}
          <i class="fas fa-file text-secondary"></i>
        {% endif %}
      </div>
      <div class="fm-card-name" title="{{ a.file.name|cut:'work_items/' }}">
        {{ a.file.name|cut:"work_items/" }}
      </div>
      <div class="fm-card-meta">{{ a.uploaded_at|date:"M d, Y" }}</div>
    </div>
  </div>
  {% endfor %}

  {% if not folders and not attachments %}
  <div class="fm-empty">
    <i class="fas fa-folder-open"></i>
    <p>This folder is empty</p>
    <small>Drag files here or click Upload Files</small>
  </div>
  {% endif %}
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu" style="display:none">
  <div class="context-menu-item" onclick="handleContextAction('rename')">
    <i class="fas fa-edit"></i> Rename
  </div>
  <div class="context-menu-item" onclick="handleContextAction('download')">
    <i class="fas fa-download"></i> Download
  </div>
  <div class="context-menu-item text-danger" onclick="handleContextAction('delete')">
    <i class="fas fa-trash"></i> Delete
  </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Folder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'admin_app:create-folder' %}">
        {% csrf_token %}
        <input type="hidden" name="parent_id" value="{{ current_folder.id }}">
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="Folder name" required autofocus>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rename</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="renameForm">
        <div class="modal-body">
          <input type="text" id="renameInput" class="form-control" required autofocus>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Rename</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<style>
:root{--primary:#1a73e8;--danger:#d93025;--success:#1e8e3e;--border:#e0e0e0;--hover:#f1f3f4;--shadow:0 1px 3px rgba(0,0,0,0.12);--drop-indicator:#1a73e8}
.fm-breadcrumb{display:flex;align-items:center;padding:16px 0;font-size:14px;flex-wrap:wrap;gap:4px}
.fm-crumb-link{color:#5f6368;text-decoration:none;padding:6px 12px;border-radius:4px;transition:all .2s;display:flex;align-items:center;position:relative}
.fm-crumb-link:hover{background:var(--hover);color:#202124}
.fm-crumb-link.drag-over{background:#e8f0fe;border:2px solid var(--drop-indicator);box-shadow:0 0 0 3px rgba(26,115,232,0.1);transform:scale(1.05)}
.fm-crumb-link.drag-invalid{background:#fce8e6;border:2px solid var(--danger)}
.fm-crumb-current{color:#202124;font-weight:500;display:flex;align-items:center;padding:6px 12px}
.dropdown-item.folder-dropzone{transition:all .2s}
.dropdown-item.folder-dropzone.drag-over{background:#e8f0fe!important;border-left:3px solid var(--drop-indicator);padding-left:13px}
.fm-toolbar{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:20px}
.fm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:20px;padding:20px 0}
.fm-card{position:relative;border:1px solid var(--border);border-radius:8px;padding:16px;background:#fff;transition:all .2s;cursor:pointer}
.fm-card:hover{box-shadow:var(--shadow);transform:translateY(-2px);border-color:#d0d0d0}
.fm-card.drag-over{border:2px dashed var(--drop-indicator);background:#e8f0fe;box-shadow:0 0 0 3px rgba(26,115,232,0.1);transform:scale(1.02)}
.fm-card.drag-over::before{content:"Drop here";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--drop-indicator);color:#fff;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:500;z-index:10;pointer-events:none}
.fm-card.drag-invalid{border:2px dashed var(--danger);background:#fce8e6}
.fm-card-menu{position:absolute;top:8px;right:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;opacity:0;transition:opacity .2s;z-index:10}
.fm-card:hover .fm-card-menu{opacity:1}
.fm-card-menu:hover{background:var(--hover)}
.fm-card-link{text-decoration:none;color:inherit;display:block}
.fm-card-icon{font-size:48px;text-align:center;margin-bottom:12px}
.fm-card-name{font-size:13px;font-weight:500;color:#202124;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px}
.fm-card-meta{font-size:11px;color:#5f6368;text-align:center}
.draggable-file,.draggable-folder{cursor:grab}
.draggable-file:active,.draggable-folder:active{cursor:grabbing;opacity:.5}
.fm-empty{grid-column:1/-1;text-align:center;padding:60px 20px;color:#5f6368}
.fm-empty i{font-size:64px;color:#dadce0;margin-bottom:16px}
.fm-empty p{font-size:16px;margin-bottom:8px}
.context-menu{position:fixed;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:1000;min-width:180px;overflow:hidden}
.context-menu-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;color:#202124}
.context-menu-item:hover{background:var(--hover)}
.context-menu-item.text-danger:hover{background:#fce8e6}
.context-menu-item i{width:16px;text-align:center}
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:10px;min-width:300px}
.toast{background:#323232;color:#fff;padding:14px 20px;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.3);animation:slideUp .3s ease;display:flex;align-items:center;gap:12px}
.toast.success{background:var(--success)}
.toast.error{background:var(--danger)}
@keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
@media (max-width:768px){.fm-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}.fm-card-icon{font-size:36px}}
</style>

<script>
const FM_URLS={moveAttachment:"{% url 'admin_app:move-attachment' %}",moveFolder:"{% url 'admin_app:move-folder' %}",renameFolder:"{% url 'admin_app:rename-folder' %}",deleteFolder:"{% url 'admin_app:delete-folder' %}",deleteFile:"{% url 'admin_app:delete-file' %}"};
let contextMenuState={type:null,id:null,name:null,isSystem:false},draggedFileIds=[],draggedFolderId=null,dragType=null;
function getCookie(e){return document.cookie.split("; ").find(t=>t.startsWith(e+"="))?.split("=")[1]}
function showToast(e,t="info"){const n=document.getElementById("toastContainer"),o=document.createElement("div");o.className=`toast ${t}`,o.innerHTML=`<i class="fas fa-${"success"===t?"check-circle":"error"===t?"exclamation-circle":"info-circle"}"></i><span>${e}</span>`,n.appendChild(o),setTimeout(()=>o.remove(),4e3)}
function isValidDropTarget(e){return!["root","year","category"].includes(e)}
function showCreateFolderModal(){new bootstrap.Modal(document.getElementById("createFolderModal")).show()}
function showRenameModal(){const e=new bootstrap.Modal(document.getElementById("renameModal")),t=document.getElementById("renameInput");t.value=contextMenuState.name,e.show(),setTimeout(()=>t.select(),300)}
function showFolderMenu(e,t,n,o){e.preventDefault(),e.stopPropagation(),contextMenuState={type:"folder",id:t,name:n,isSystem:o},showContextMenu(e)}
function showFileMenu(e,t,n){e.preventDefault(),e.stopPropagation(),contextMenuState={type:"file",id:t,name:n,isSystem:!1},showContextMenu(e)}
function showContextMenu(e){const t=document.getElementById("contextMenu");t.querySelectorAll(".context-menu-item").forEach(e=>{const t=e.getAttribute("onclick").match(/'(.+?)'/)[1];contextMenuState.isSystem?e.style.display="download"===t?"flex":"none":"folder"===contextMenuState.type?e.style.display="download"!==t?"flex":"none":e.style.display="rename"!==t?"flex":"none"}),t.style.display="block",t.style.left=e.pageX+"px",t.style.top=e.pageY+"px"}
function handleContextAction(e){document.getElementById("contextMenu").style.display="none","rename"===e?showRenameModal():"download"===e?handleDownload():"delete"===e&&handleDelete()}
async function handleRename(e){if(!e.trim())return;try{const t=await fetch(FM_URLS.renameFolder,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({folder_id:contextMenuState.id,new_name:e})}),n=await t.json();showToast(n.message,"success"===n.status?"success":"error"),"success"===n.status&&setTimeout(()=>location.reload(),800)}catch(e){showToast("An error occurred","error")}}
function handleDownload(){"file"===contextMenuState.type?window.location.href=`/admin/documents/files/download/${contextMenuState.id}/`:showToast("Folder download coming soon","info")}
async function handleDelete(){if(!confirm(`Delete "${contextMenuState.name}"?`))return;const e="file"===contextMenuState.type?FM_URLS.deleteFile:FM_URLS.deleteFolder,t="file"===contextMenuState.type?"attachment_id":"folder_id";try{const n=await fetch(e,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({[t]:contextMenuState.id})}),o=await n.json();showToast(o.message,"success"===o.status?"success":"error"),"success"===o.status&&setTimeout(()=>location.reload(),800)}catch(e){showToast("An error occurred","error")}}
function handleFileUpload(e){const t=document.getElementById("uploadForm"),n=e.target.files;n.length>0&&(showToast(`Uploading ${n.length} file(s)...`,"info"),t.submit())}
async function moveDraggedItem(e,t){if("file"===dragType&&draggedFileIds.length>0){if(!isValidDropTarget(t))return void showToast("Cannot drop files here","error");try{const n=await fetch(FM_URLS.moveAttachment,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({"attachment_ids[]":draggedFileIds,folder_id:e})}),o=await n.json();showToast(o.message,"success"===o.status?"success":"error"),"success"===o.status&&setTimeout(()=>location.reload(),800)}catch(e){showToast("An error occurred","error")}}if("folder"===dragType&&draggedFolderId){if(draggedFolderId===e)return void showToast("Cannot move folder into itself","error");try{const t=await fetch(FM_URLS.moveFolder,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({folder_id:draggedFolderId,target_folder_id:e})}),n=await t.json();showToast(n.message,"success"===n.status?"success":"error"),"success"===n.status&&setTimeout(()=>location.reload(),800)}catch(e){showToast("An error occurred","error")}}}
function setupDragAndDrop(){document.querySelectorAll(".draggable-file").forEach(e=>{e.addEventListener("dragstart",t=>{draggedFileIds=[e.dataset.attachmentId],dragType="file",t.dataTransfer.effectAllowed="move"})}),document.querySelectorAll(".draggable-folder").forEach(e=>{e.addEventListener("dragstart",t=>{draggedFolderId=e.dataset.folderId,dragType="folder",t.dataTransfer.effectAllowed="move"})}),document.querySelectorAll(".folder-dropzone").forEach(e=>{e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation();const n=e.dataset.folderType;"folder"===dragType&&draggedFolderId===e.dataset.folderId?(e.classList.add("drag-invalid"),t.dataTransfer.dropEffect="none"):"file"===dragType&&!isValidDropTarget(n)?(e.classList.add("drag-invalid"),t.dataTransfer.dropEffect="none"):(e.classList.add("drag-over"),t.dataTransfer.dropEffect="move")}),e.addEventListener("dragleave",t=>{e.contains(t.relatedTarget)||e.classList.remove("drag-over","drag-invalid")}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over","drag-invalid");const n=e.dataset.folderId,o=e.dataset.folderType;moveDraggedItem(n,o),draggedFileIds=[],draggedFolderId=null,dragType=null})})}
document.addEventListener("click",()=>{document.getElementById("contextMenu").style.display="none"}),document.getElementById("renameForm").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("renameInput").value.trim();handleRename(t),bootstrap.Modal.getInstance(document.getElementById("renameModal")).hide()}),document.addEventListener("DOMContentLoaded",()=>{setupDragAndDrop()});
</script>

{% endblock %}