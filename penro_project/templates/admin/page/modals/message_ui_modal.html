<!-- ============================================
     QXDLG MODAL - Floating Chat Panel
============================================ -->
<div class="qxdlg-modal-overlay" id="qxdlgDiscussionModal" data-qxdlg-state="closed">
  <div class="qxdlg-modal-container">
    
    <div class="qxdlg-header-bar">
      <div class="qxdlg-header-left">
        <div class="qxdlg-icon-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>

        <div class="qxdlg-title-group">
          <h3 class="qxdlg-title-text" id="qxdlgTitle">
            Discussion
          </h3>
          <span class="qxdlg-subtitle-text" id="qxdlgSubtitle">
            <!-- Assigned user -->
          </span>
        </div>

      </div>
      <button type="button" class="qxdlg-close-btn" data-qxdlg-dismiss>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="qxdlg-body-wrap">
      <div class="qxdlg-loader-spin" id="qxdlgLoader">
        <div class="qxdlg-spinner"></div>
        <span>Loading messages...</span>
      </div>
      <iframe
        id="qxdlgFrame"
        class="qxdlg-iframe-embed"
        title="Discussion Thread"
        src="">
      </iframe>
    </div>

  </div>
</div>

<style>
/* ============================================
   QXDLG MODAL STYLES
============================================ */
.qxdlg-modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"] {
  pointer-events: auto;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"]::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.4);
  backdrop-filter: blur(4px);
  animation: qxdlg-fadein 0.25s ease;
}

.qxdlg-modal-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 420px;
  max-width: calc(100vw - 48px);
  height: 600px;
  max-height: calc(100vh - 48px);
  background: #ffffff;
  border-radius: 20px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 
    0 25px 50px -12px rgba(0, 0, 0, 0.25),
    0 0 0 1px rgba(0, 0, 0, 0.05);
  transform: translateY(100%) scale(0.95);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: auto;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"] .qxdlg-modal-container {
  transform: translateY(0) scale(1);
  opacity: 1;
}

.qxdlg-header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: linear-gradient(135deg, #6366f1 0%, #7c3aed 50%, #8b5cf6 100%);
  color: #ffffff;
  flex-shrink: 0;
}

.qxdlg-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.qxdlg-icon-wrap {
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.qxdlg-icon-wrap svg {
  width: 22px;
  height: 22px;
}

.qxdlg-title-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.qxdlg-title-text {
  font-size: 16px;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.02em;
}



@keyframes qxdlg-pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

.qxdlg-close-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  transition: all 0.2s ease;
}

.qxdlg-close-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: rotate(90deg);
}

.qxdlg-close-btn svg {
  width: 18px;
  height: 18px;
}
.qxdlg-subtitle-text {
  font-size: 12px;
  opacity: 0.9;
  font-weight: 500;
}

.qxdlg-body-wrap {
  flex: 1;
  position: relative;
  background: #f8fafc;
  overflow: hidden;
}

.qxdlg-loader-spin {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  background: #f8fafc;
  z-index: 10;
  color: #64748b;
  font-size: 13px;
  font-weight: 500;
}

.qxdlg-loader-spin[data-qxdlg-hidden="true"] {
  display: none;
}

.qxdlg-spinner {
  width: 36px;
  height: 36px;
  border: 3px solid #e2e8f0;
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: qxdlg-spin 0.8s linear infinite;
}

@keyframes qxdlg-spin {
  to { transform: rotate(360deg); }
}

.qxdlg-iframe-embed {
  width: 100%;
  height: 100%;
  border: none;
  background: #f8fafc;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.qxdlg-iframe-embed[data-qxdlg-loaded="true"] {
  opacity: 1;
}

@keyframes qxdlg-fadein {
  from { opacity: 0; }
  to { opacity: 1; }
}

@media (max-width: 480px) {
  .qxdlg-modal-container {
    bottom: 0;
    right: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border-radius: 0;
  }
}
</style>

<script>
(function () {

  /* ===============================
     CORE ELEMENTS
  =============================== */
  const modal = document.getElementById('qxdlgDiscussionModal');
  if (!modal) return;

  const iframe   = modal.querySelector('#qxdlgFrame');
  const loader   = modal.querySelector('#qxdlgLoader');
  const closeBtn = modal.querySelector('[data-qxdlg-dismiss]');
  const titleEl  = modal.querySelector('#qxdlgTitle');
  const subtitleEl = modal.querySelector('#qxdlgSubtitle');

  /* ===============================
     OPEN MODAL
  =============================== */
  function openModal(url, title, subtitle) {
    if (!url) return;

    loader.removeAttribute('data-qxdlg-hidden');
    iframe.removeAttribute('data-qxdlg-loaded');
    iframe.src = url;

    if (titleEl) {
      titleEl.textContent = title || 'Discussion';
    }

    if (subtitleEl) {
      subtitleEl.textContent = subtitle || '';
    }

    modal.setAttribute('data-qxdlg-state', 'open');
    document.body.style.overflow = 'hidden';
  }

  /* ===============================
     CLOSE MODAL
  =============================== */
  function closeModal() {
    modal.setAttribute('data-qxdlg-state', 'closed');
    document.body.style.overflow = '';

    setTimeout(function () {
      iframe.src = '';
    }, 350);
  }

  /* ===============================
     IFRAME LOAD HANDLER
  =============================== */
  iframe.addEventListener('load', function () {
    loader.setAttribute('data-qxdlg-hidden', 'true');
    iframe.setAttribute('data-qxdlg-loaded', 'true');
  });

  /* ===============================
     UI EVENTS
  =============================== */
  closeBtn.addEventListener('click', closeModal);

  modal.addEventListener('click', function (e) {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && modal.getAttribute('data-qxdlg-state') === 'open') {
      closeModal();
    }
  });

  /* ===============================
     TRIGGER BINDING
  =============================== */
  function attachTriggers() {
    document.querySelectorAll('[data-qxdlg-trigger]').forEach(function (trigger) {

      if (trigger.hasAttribute('data-qxdlg-bound')) return;
      trigger.setAttribute('data-qxdlg-bound', 'true');

      trigger.addEventListener('click', function (e) {
        e.preventDefault();

        const url = this.getAttribute('data-qxdlg-url');
        const title = this.getAttribute('data-qxdlg-title');
        const subtitle = this.getAttribute('data-qxdlg-subtitle');

        openModal(url, title, subtitle);
      });
    });
  }

  /* ===============================
     INIT
  =============================== */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachTriggers);
  } else {
    attachTriggers();
  }

  /* ===============================
     GLOBAL API
  =============================== */
  window.qxdlgDiscussion = {
    open: openModal,
    close: closeModal,
    attachTriggers: attachTriggers
  };

})();
</script>
