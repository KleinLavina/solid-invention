{% extends "admin/layout/base.html" %}
{% block title %}Users{% endblock %}
{% block content %}

<!-- =========================
     HEADER
========================= -->
<div class="users-header">
  <div>
    <h3 class="fw-bold mb-0">
      Users
      <span class="user-count">{{ total_users }}</span>
    </h3>
    <div class="text-muted small">
      TIWI Reference · User Directory
    </div>
  </div>

  <a href="#"
     class="btn-add-user"
     data-bs-toggle="modal"
     data-bs-target="#createUserModal">
    + Add User
  </a>
</div>

<hr class="my-3">

<!-- =========================
     USER GRID
========================= -->
<div class="user-grid">
  {% for user in users %}
  <div class="user-card">

    <span class="badge badge-division">
      {{ user.division.name|default:"No Division" }}
    </span>

    <span class="badge badge-role {% if user.login_role == 'admin' %}admin{% else %}user{% endif %}">
      {{ user.get_login_role_display }}
    </span>

    <div class="user-center">
      <img class="avatar"
           src="https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username }}&background=2563eb&color=fff">
      <div class="user-name">
        {{ user.get_full_name|default:user.username }}
      </div>
      <div class="user-position">
        {{ user.position_title|default:"No position title" }}
      </div>
    </div>

    <hr>

    <div class="user-details">
      <div><strong>Username:</strong> {{ user.username }}</div>
      <div><strong>Email:</strong> {{ user.email|default:"—" }}</div>
      <div>
        <strong>Status:</strong>
        {% if user.is_active %}
          <span class="status active">Active</span>
        {% else %}
          <span class="status inactive">Inactive</span>
        {% endif %}
      </div>
    </div>

  </div>
  {% endfor %}
</div>

<!-- =========================
     MODALS
========================= -->

{% include "admin/page/modals/create_user_modal.html" %}

<!-- ONBOARDING MODAL -->
<div class="modal fade"
     id="onboardModal"
     tabindex="-1"
     aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-body" id="onboardModalBody">
        <!-- onboarding content injected here -->
      </div>
    </div>
  </div>
</div>

<!-- =========================
     STYLES
========================= -->
<style>
.users-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:.75rem;
}

.user-count{
  background:#eef2ff;
  color:#4338ca;
  font-size:.75rem;
  padding:.15rem .5rem;
  border-radius:999px;
  margin-left:.35rem;
}

.btn-add-user{
  background:#2563eb;
  color:#fff;
  padding:.45rem .85rem;
  border-radius:6px;
  font-size:.85rem;
  text-decoration:none;
}

.user-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:1.25rem;
}

.user-card{
  position:relative;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:1.25rem;
}

.badge{
  position:absolute;
  font-size:.7rem;
  padding:.25rem .6rem;
  border-radius:999px;
}

.badge-division{ top:.6rem; left:.6rem; background:#f3f4f6; }
.badge-role{ top:.6rem; right:.6rem; color:#fff; }
.badge-role.admin{ background:#dc2626; }
.badge-role.user{ background:#2563eb; }

.avatar{
  width:80px;
  height:80px;
  border-radius:50%;
}

.status.active{ color:#16a34a; }
.status.inactive{ color:#dc2626; }
</style>

<!-- =========================
     JAVASCRIPT (ALL LOGIC HERE)
========================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  /* CREATE USER SUBMIT */
  const createForm = document.getElementById("createUserForm");

  if (createForm) {
    createForm.addEventListener("submit", function (e) {
      e.preventDefault();

      fetch(createForm.action, {
        method: "POST",
        body: new FormData(createForm),
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.text())
      .then(text => JSON.parse(text))
      .then(data => {
        if (!data.success) {
          alert("Form error. Check inputs.");
          return;
        }

        bootstrap.Modal
          .getInstance(document.getElementById("createUserModal"))
          .hide();

        loadOnboarding(data.onboard_url);
      })
      .catch(err => {
        console.error(err);
        alert("Unexpected error. Please try again.");
      });
    });
  }

  /* ONBOARDING LOADER */
  window.loadOnboarding = function (url) {
    const modalEl = document.getElementById("onboardModal");
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const body = document.getElementById("onboardModalBody");

    body.innerHTML = "<div class='text-center py-5'>Loading…</div>";

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(res => res.text())
      .then(html => {
        body.innerHTML = html;
        modal.show();
      });
  };

  /* ONBOARDING STEP SUBMIT */
  document.addEventListener("submit", function (e) {
    const form = e.target.closest(".onboard-form");
    if (!form) return;

    e.preventDefault();

    fetch(form.action, {
      method: "POST",
      body: new FormData(form),
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
      if (data.next) {
        loadOnboarding(data.next);
      }
    });
  });

});
</script>

{% endblock %}
