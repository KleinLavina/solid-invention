{% extends "user/layout/base.html" %}

{% block title %}
Work Item Details
{% endblock %}

{% block content %}
<style>
:root {
  --navy-900: #0a1628;
  --navy-800: #0f2744;
  --navy-700: #1a3a5c;
  --navy-600: #254d73;
  --navy-500: #3a6ea5;
  --slate-600: #475569;
  --slate-500: #64748b;
  --slate-400: #94a3b8;
  --slate-200: #e2e8f0;
  --slate-100: #f1f5f9;
  --white: #ffffff;
  
  --cyan-400: #22d3ee;
  --cyan-500: #06b6d4;
  --emerald-400: #34d399;
  --emerald-500: #10b981;
  --amber-400: #fbbf24;
  --amber-500: #f59e0b;
  --rose-400: #fb7185;
  --rose-500: #f43f5e;
  --violet-400: #a78bfa;
  --violet-500: #8b5cf6;
  
  --shadow-sm: 0 1px 3px rgba(10,22,40,0.08);
  --shadow-md: 0 4px 12px rgba(10,22,40,0.1);
  --shadow-lg: 0 10px 30px rgba(10,22,40,0.15);
}

.work-item-page {
  background: var(--slate-100);
  min-height: 100vh;
  padding: .5rem 3rem;
}

/* Header Card */
.header-card {
  background: var(--navy-800);
  border-radius: 16px;
  padding: 1.75rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-lg);
}

.header-title {
  color: var(--white);
  font-weight: 700;
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.header-title i { color: var(--cyan-400); }

.header-meta {
  color: var(--slate-400);
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.header-meta i { color: var(--amber-400); }

.header-description {
  color: var(--slate-400);
  margin-top: 0.75rem;
  font-size: 0.875rem;
  line-height: 1.6;
}

.btn-action {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--white);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.btn-action:hover {
  background: rgba(255,255,255,0.2);
  color: var(--cyan-400);
  transform: translateY(-2px);
}

/* Main Grid */
.main-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

@media (max-width: 992px) {
  .main-grid { grid-template-columns: 1fr; }
}

/* Cards */
.panel-card {
  background: var(--white);
  border: 1px solid var(--slate-200);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  height: 100%;
  display: flex;
  flex-direction: column;
}

.panel-header {
  background: var(--navy-800);
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 600;
  color: var(--white);
}

.panel-header i { font-size: 1.1rem; }
.panel-header .icon-cyan { color: var(--cyan-400); }
.panel-header .icon-amber { color: var(--amber-400); }

.panel-body {
  padding: 1.5rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* Status Section with Floating Indicator */
.status-section {
  margin-bottom: 1.75rem;
}

.section-label {
  color: var(--slate-500);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.status-hint {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding: 0.5rem 0.75rem;
  background: linear-gradient(135deg, rgba(34,211,238,0.1), rgba(139,92,246,0.1));
  border: 1px dashed var(--cyan-500);
  border-radius: 8px;
  animation: pulse-border 2s ease-in-out infinite;
}

@keyframes pulse-border {
  0%, 100% { border-color: var(--cyan-500); }
  50% { border-color: var(--violet-500); }
}

.status-hint i {
  color: var(--cyan-500);
  font-size: 0.875rem;
  animation: bounce 1.5s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.status-hint span {
  color: var(--navy-700);
  font-size: 0.8rem;
  font-weight: 500;
}

.status-toggle-group {
  display: flex;
  gap: 0.75rem;
}

.status-btn {
  flex: 1;
  padding: 1rem 1.25rem;
  border: 2px solid var(--slate-200);
  background: var(--slate-100);
  color: var(--slate-500);
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
}

.status-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.5));
  opacity: 0;
  transition: opacity 0.25s ease;
}

.status-btn:hover {
  border-color: var(--navy-500);
  color: var(--navy-700);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.status-btn:hover::before { opacity: 1; }

.status-btn.active-not-started {
  background: var(--navy-700);
  border-color: var(--navy-600);
  color: var(--white);
  box-shadow: var(--shadow-md);
}

.status-btn.active-progress {
  background: linear-gradient(135deg, var(--amber-400), var(--amber-500));
  border-color: var(--amber-500);
  color: var(--navy-900);
  box-shadow: 0 4px 20px rgba(251,191,36,0.4);
}

.status-btn i.spin {
  animation: spin 1.5s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Completed Alert */
.completed-alert {
  background: linear-gradient(135deg, var(--emerald-400), var(--emerald-500));
  color: var(--white);
  padding: 1rem 1.25rem;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 600;
  box-shadow: 0 4px 20px rgba(52,211,153,0.3);
}

/* Meta Section - Improved spacing */
.meta-section {
  background: var(--slate-100);
  border-radius: 12px;
  padding: 1.25rem;
  margin-bottom: 1.5rem;
}

.meta-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--slate-200);
}

.meta-row:last-child { border-bottom: none; }

.meta-label {
  color: var(--slate-500);
  font-size: 0.875rem;
  font-weight: 500;
}

.meta-value {
  font-weight: 600;
  color: var(--navy-800);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Badges */
.badge-status {
  padding: 0.4rem 0.85rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.badge-approved {
  background: var(--emerald-500);
  color: var(--white);
}

.badge-revision {
  background: var(--rose-500);
  color: var(--white);
}

.badge-pending {
  background: var(--cyan-500);
  color: var(--white);
}

/* Submit Section */
.submit-section {
  margin-top: auto;
  padding-top: 1.25rem;
  border-top: 1px solid var(--slate-200);
}

.btn-submit {
  width: 100%;
  padding: 1rem 1.5rem;
  background: linear-gradient(135deg, var(--emerald-400), var(--emerald-500));
  border: none;
  border-radius: 12px;
  color: var(--white);
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-submit:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(52,211,153,0.4);
}

.btn-submit:disabled {
  background: var(--slate-300);
  color: var(--slate-500);
  cursor: not-allowed;
}

.submit-hint {
  color: var(--slate-500);
  font-size: 0.8rem;
  text-align: center;
  margin-top: 0.75rem;
}

/* Notes Form */
.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  color: var(--slate-600);
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 0.5rem;
  display: block;
  font-weight: 600;
}

.form-input {
  width: 100%;
  padding: 0.875rem 1rem;
  background: var(--white);
  border: 2px solid var(--slate-200);
  border-radius: 10px;
  color: var(--navy-800);
  font-size: 0.9rem;
  transition: all 0.2s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--cyan-500);
  box-shadow: 0 0 0 4px rgba(6,182,212,0.15);
}

.form-input::placeholder { color: var(--slate-400); }

textarea.form-input {
  resize: vertical;
  min-height: 120px;
}

/* Status Chips */
.chips-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.status-chip {
  padding: 0.45rem 0.85rem;
  background: var(--white);
  border: 1px solid var(--slate-300);
  border-radius: 20px;
  color: var(--slate-600);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.status-chip:hover {
  background: var(--navy-800);
  border-color: var(--navy-800);
  color: var(--white);
  transform: translateY(-2px);
}

.btn-save {
  padding: 0.75rem 1.5rem;
  background: var(--navy-800);
  border: none;
  border-radius: 10px;
  color: var(--white);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-save:hover {
  background: var(--navy-700);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Attachments */
.attachments-section {
  margin-top: 2rem;
}

.section-title {
  color: var(--navy-800);
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-title i { color: var(--violet-500); }

.attachments-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
}

@media (max-width: 768px) {
  .attachments-grid { grid-template-columns: 1fr; }
}

.attachment-card {
  background: var(--white);
  border: 2px solid var(--slate-200);
  border-radius: 14px;
  padding: 1.5rem;
  text-align: center;
  text-decoration: none;
  transition: all 0.25s ease;
  display: block;
}

.attachment-card:hover {
  transform: translateY(-4px);
  border-color: var(--navy-500);
  box-shadow: var(--shadow-lg);
}

.attachment-icon {
  font-size: 2.5rem;
  margin-bottom: 0.75rem;
}

.attachment-icon.uploaded { color: var(--emerald-500); }
.attachment-icon.pending { color: var(--slate-400); }

.attachment-title {
  color: var(--navy-800);
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 0.75rem;
}

.badge-uploaded {
  background: var(--emerald-500);
  color: var(--white);
  padding: 0.35rem 0.85rem;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
}

.badge-not-uploaded {
  background: var(--slate-200);
  color: var(--slate-500);
  padding: 0.35rem 0.85rem;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
}
/* ===============================
   USER ACTION BUTTONS (WHITE UI)
================================ */
.ux-btn{
  background:#ffffff;
  border:1px solid #dbe3f0;
  border-radius:10px;
  padding:6px 14px;
  font-weight:600;
  font-size:.8rem;
  display:inline-flex;
  align-items:center;
  gap:6px;
  transition:all .2s ease;
  box-shadow:0 1px 3px rgba(15,23,42,.04);
}

/* PRIMARY (Discussion) */
.ux-btn-primary{
  color:#1e3a8a; /* dark blue */
}

.ux-btn-primary i{
  color:#1e3a8a;
}

.ux-btn-primary:hover{
  background:#f0f5ff;
  border-color:#93c5fd;
  color:#1d4ed8;
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(29,78,216,.15);
}

/* SECONDARY (Home) */
.ux-btn-secondary{
  color:#334155;
}

.ux-btn-secondary i{
  color:#475569;
}

.ux-btn-secondary:hover{
  background:#f8fafc;
  border-color:#cbd5e1;
  transform:translateY(-1px);
  box-shadow:0 4px 10px rgba(15,23,42,.1);
}

/* Focus (keyboard users) */
.ux-btn:focus-visible{
  outline:2px solid #93c5fd;
  outline-offset:2px;
}
/* ===============================
   UNDO SUBMISSION BUTTON
================================ */
.btn-undo{
  background:#dc2626;          /* red-600 */
  color:#ffffff;
  border:none;
  border-radius:10px;
  padding:6px 14px;
  font-size:.75rem;
  font-weight:700;
  display:inline-flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  transition:
    transform .15s ease,
    box-shadow .15s ease,
    background .15s ease;
  box-shadow:0 4px 10px rgba(220,38,38,.35);
}

.btn-undo i{
  font-size:.75rem;
}

/* Hover effect */
.btn-undo:hover{
  background:#b91c1c;          /* red-700 */
  transform:scale(1.06);
  box-shadow:0 8px 18px rgba(185,28,28,.45);
}

/* Active (click) */
.btn-undo:active{
  transform:scale(0.97);
}

/* Focus (keyboard accessibility) */
.btn-undo:focus-visible{
  outline:2px solid #fecaca;
  outline-offset:2px;
}

</style>

<div class="work-item-page">
  <!-- Header -->
  <div class="header-card">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div class="flex-grow-1">
        <h4 class="header-title">
          <i class="fas fa-layer-group"></i>
          {{ work_item.workcycle.title }}
        </h4>
       <div class="header-meta">
  <i class="far fa-calendar-alt"></i>
  Due {{ work_item.workcycle.due_at|date:"l, F j, Y · g:i A" }}
</div>

        {% if work_item.workcycle.description %}
        <div class="header-description">{{ work_item.workcycle.description }}</div>
        {% endif %}
      </div>
             <div class="d-flex gap-2">
                <a href="#"
                  class="btn btn-sm ux-btn ux-btn-primary"
                  data-qxdlg-trigger
                  data-qxdlg-url="{% url 'user_app:work-item-discussion' work_item.id %}"
                  data-qxdlg-title="{{ work_item.workcycle.title }}"
                  data-qxdlg-subtitle="Assigned by: {{ work_item.workcycle.created_by|default:'System' }}">
                  <i class="fas fa-comment-dots me-1"></i> Discussion
                </a>

                <a href="{% url 'user_app:work-items' %}"
                  class="btn btn-sm ux-btn ux-btn-secondary">
                  <i class="fas fa-home me-1"></i> Home
                </a>
            </div>



    </div>
  </div>

  <!-- Main Content -->
  <div class="main-grid">
    <!-- Details Panel -->
    <div class="panel-card">
      <div class="panel-header">
        <i class="fas fa-info-circle icon-cyan"></i>
        Status & Details
      </div>
      <div class="panel-body">
        <!-- Status Section -->
        <div class="status-section">
          <div class="section-label">Current Status</div>
          
          {% if work_item.status != "done" %}
          <!-- Floating Indicator -->
          <div class="status-hint">
            <i class="fas fa-hand-pointer"></i>
            <span>Click to update your work status</span>
          </div>
          
          <div class="status-toggle-group">
            <form method="post" class="flex-fill">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_status">
              <input type="hidden" name="status" value="not_started">
              <button type="submit" class="status-btn {% if work_item.status == 'not_started' %}active-not-started{% endif %}">
                <i class="fas fa-circle"></i> Not Started
              </button>
            </form>
            <form method="post" class="flex-fill">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_status">
              <input type="hidden" name="status" value="working_on_it">
              <button type="submit" class="status-btn {% if work_item.status == 'working_on_it' %}active-progress{% endif %}">
                <i class="fas fa-spinner {% if work_item.status == 'working_on_it' %}spin{% endif %}"></i> In Progress
              </button>
            </form>
          </div>
          {% else %}
<div class="completed-alert d-flex justify-content-between align-items-center">
  <div>
    <i class="fas fa-check-circle"></i> Completed
  </div>

  {% if work_item.review_decision == "pending" %}
  <form method="post">
  {% csrf_token %}
  <input type="hidden" name="action" value="undo_submit">
  <button type="submit" class="btn-undo">
    <i class="fas fa-undo"></i> Undo Submission
  </button>
</form>

  {% endif %}
</div>
{% endif %}

        </div>

        <!-- Meta Info -->
        <div class="meta-section">
          <div class="meta-row">
            <span class="meta-label">Review Status</span>
            <span class="badge-status {% if work_item.review_decision == 'approved' %}badge-approved{% elif work_item.review_decision == 'revision' %}badge-revision{% else %}badge-pending{% endif %}">
              {{ work_item.get_review_decision_display }}
            </span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Submitted</span>
            <span class="meta-value">
              {% if work_item.submitted_at %}
              <i class="fas fa-check-circle" style="color: var(--emerald-500);"></i>
              {{ work_item.submitted_at|date:"M d, Y · H:i" }}
              {% else %}
              <i class="fas fa-clock" style="color: var(--slate-400);"></i>
              Not yet
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Submit Button -->
        {% if work_item.status != "done" %}
        <div class="submit-section">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="submit">
            <button type="submit" class="btn-submit" {% if not attachments %}disabled{% endif %}>
              <i class="fas fa-check-circle"></i> Mark as Done & Submit
            </button>
          </form>
          {% if not attachments %}
          <div class="submit-hint">Upload at least one attachment before submitting.</div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Notes Panel -->
    <form method="post" class="panel-card">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_context">
      <div class="panel-header">
        <i class="fas fa-sticky-note icon-amber"></i>
        Notes
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label class="form-label">Status Label</label>
          <input type="text" id="statusLabelInput" name="status_label" class="form-input" placeholder="e.g. Waiting for documents" value="{{ work_item.status_label }}">
          <div class="chips-container">
            <button type="button" class="status-chip" data-value="Waiting for approval">Waiting for approval</button>
            <button type="button" class="status-chip" data-value="In review">In review</button>
            <button type="button" class="status-chip" data-value="Needs revision">Needs revision</button>
            <button type="button" class="status-chip" data-value="On hold">On hold</button>
            <button type="button" class="status-chip" data-value="For validation">For validation</button>
            <button type="button" class="status-chip" data-value="Pending documents">Pending documents</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea name="message" class="form-input" rows="4" placeholder="Add notes or remarks here...">{{ work_item.message }}</textarea>
        </div>
        <button type="submit" class="btn-save">
          <i class="fas fa-save"></i> Save Notes
        </button>
      </div>
    </form>
  </div>

  <!-- Attachments -->
  <div class="attachments-section">
    <h5 class="section-title"><i class="fas fa-paperclip"></i> Attachments</h5>
    <div class="attachments-grid">
      {% for key, label in attachment_types %}
      <a href="{% url 'user_app:work-item-attachments' work_item.id %}?type={{ key }}" class="attachment-card">
        <i class="fas fa-folder-open attachment-icon {% if key in uploaded_types %}uploaded{% else %}pending{% endif %}"></i>
        <div class="attachment-title">{{ label }}</div>
        {% if key in uploaded_types %}
        <span class="badge-uploaded">Uploaded</span>
        {% else %}
        <span class="badge-not-uploaded">Not Uploaded</span>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("statusLabelInput");
  document.querySelectorAll(".status-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      input.value = chip.dataset.value;
      input.focus();
    });
  });
});
</script>
{% include "admin/page/modals/message_ui_modal.html" %}
{% endblock %}
