{% extends "user/layout/base.html" %}
{% block title %}Work Item{% endblock %}
{% block content %}

<style>
:root{
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --primary:#4f46e5;
  --success:#10b981;
  --info:#3b82f6;
  --warning:#f59e0b;
  --danger:#ef4444;
}

/* ===== Layout ===== */
.work-wrapper{
  max-width:920px;
  margin:auto;
}

/* ===== Card ===== */
.card{
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
  margin-bottom:1.25rem;
}
.card-header{
  background:#f8fafc;
  border-bottom:1px solid var(--border);
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card-body{
  padding:1rem 1.25rem;
}

/* ===== Badges ===== */
.badge{
  font-size:.72rem;
  border-radius:999px;
  padding:.35rem .7rem;
}
.bg-not-started{background:#6b7280;color:#fff}
.bg-working{background:#3b82f6;color:#fff}
.bg-done{background:#10b981;color:#fff}
.bg-pending{background:#f59e0b;color:#111}
.bg-approved{background:#10b981;color:#fff}
.bg-needs-revision{background:#ef4444;color:#fff}

/* ===== Status Buttons ===== */
.status-actions{
  display:flex;
  gap:.5rem;
  flex-wrap:wrap;
}
.status-btn{
  border:none;
  padding:.4rem .85rem;
  font-size:.75rem;
  font-weight:600;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  transition:.2s ease;
}
.status-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.12);
}
.status-active{
  background:linear-gradient(135deg,#6366f1,#22d3ee);
  color:#111;
}
.status-working .icon{
  animation:spin 1.4s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== Utilities ===== */
.small-muted{
  font-size:.75rem;
  color:var(--muted);
}
.section-title{
  font-size:.75rem;
  font-weight:600;
  text-transform:uppercase;
  color:#475569;
  letter-spacing:.04em;
  margin-bottom:.35rem;
}
.drop-area{
  border:2px dashed var(--border);
  border-radius:12px;
  padding:1.25rem;
  text-align:center;
  cursor:pointer;
  transition:.2s ease;
  background:#f8fafc;
}
.drop-area.dragover{
  background:#eef2ff;
  border-color:var(--primary);
}

</style>

<div class="work-wrapper">

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom">
  <div>
    <h6 class="mb-1 fw-semibold">
      <i class="fas fa-tasks text-primary me-1"></i>
      {{ work_item.workcycle.title }}
    </h6>
    <div class="small-muted">
      <i class="far fa-calendar-alt me-1"></i>
      Due {{ work_item.workcycle.due_at|date:"M d, Y · H:i" }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'user_app:work-item-comments' work_item.id %}"
   class="btn btn-sm btn-outline-primary">
  <i class="fas fa-comment-dots me-1"></i>
  Discussion
</a>


    <a href="{% url 'user_app:work-items' %}" class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i>Back
    </a>
  </div>
</div>

<!-- ================= DESCRIPTION ================= -->
{% if work_item.workcycle.description %}
<div class="card">
  <div class="card-header">
    <i class="fas fa-align-left text-primary me-1"></i>
    Description
  </div>
  <div class="card-body">
    <p class="mb-0 small text-muted" style="white-space: pre-line;">
      {{ work_item.workcycle.description }}
    </p>
  </div>
</div>
{% endif %}

<!-- ================= DETAILS ================= -->
<div class="card">
  <div class="card-header">
    <span>
      <i class="fas fa-info-circle text-primary me-1"></i>
      Details
    </span>

    <span class="badge
      {% if work_item.review_decision == 'pending' %}bg-pending
      {% elif work_item.review_decision == 'approved' %}bg-approved
      {% elif work_item.review_decision == 'revision' %}bg-needs-revision{% endif %}">
      {{ work_item.get_review_decision_display }}
    </span>
  </div>

  <div class="card-body">

    <!-- STATUS -->
    <div class="mb-3">
      <div class="section-title">Work Status</div>

      {% if can_edit %}
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_status">

        <div class="status-actions">
          {% for v,l in status_choices %}
            {% if v != "done" %}
            <button type="submit"
                    name="status"
                    value="{{ v }}"
                    class="status-btn
                    {% if work_item.status == v %}
                      status-active
                    {% elif v == 'not_started' %}
                      bg-not-started
                    {% elif v == 'working_on_it' %}
                      bg-working status-working
                    {% endif %}">
              <i class="fas
                {% if v == 'not_started' %}fa-pause-circle
                {% elif v == 'working_on_it' %}fa-spinner{% endif %}
                icon"></i>
              {{ l }}
            </button>
            {% endif %}
          {% endfor %}
        </div>
      </form>
      {% else %}
        <span class="badge bg-done">
          {{ work_item.get_status_display }}
        </span>
      {% endif %}
    </div>

    <!-- SUBMISSION TIME -->
    <div class="small-muted border-top pt-2">
      <i class="far fa-clock me-1"></i>
      Submitted:
      {% if work_item.submitted_at %}
        {{ work_item.submitted_at|date:"M d, Y · H:i" }}
      {% else %}
        <span class="text-warning">Not submitted</span>
      {% endif %}
    </div>

  </div>
</div>

<!-- ================= NOTES ================= -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-comment-dots me-1"></i>
    Notes
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_context">

      <input class="form-control form-control-sm mb-2"
             name="status_label"
             value="{{ work_item.status_label }}"
             placeholder="Short status label">

      <textarea class="form-control form-control-sm mb-2"
                name="message"
                rows="3"
                placeholder="Optional message...">{{ work_item.message }}</textarea>

      <button class="btn btn-sm btn-outline-primary">
        <i class="fas fa-save me-1"></i>Save
      </button>
    </form>
  </div>
</div>

<!-- ================= ATTACHMENTS ================= -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-paperclip me-1"></i>
    Attachments
  </div>
  <div class="card-body">
    {% if work_item.attachments.all %}
      <ul class="list-group list-group-flush">
        {% for f in work_item.attachments.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <a href="{{ f.file.url }}" download class="small text-decoration-none">
            <i class="far fa-file me-1"></i>
            {{ f.file.name|slice:"-35:" }}
          </a>
          <span class="small-muted">
            {{ f.uploaded_at|date:"M d · H:i" }}
          </span>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="small-muted fst-italic">
        No attachments yet
      </div>
    {% endif %}
  </div>
</div>

<!-- ================= UPLOAD / SUBMIT ================= -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-upload me-1"></i>
    {% if can_edit %}Submit Work{% else %}Add Attachment{% endif %}
  </div>
  <div class="card-body">
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="action" value="add_attachment">

  <!-- Hidden real input -->
  <input type="file"
         id="attachmentInput"
         name="attachments"
         multiple
         hidden>

  <!-- Drop area -->
  <div id="dropArea" class="drop-area">
    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
    <p class="mb-1"><strong>Drag & drop files here</strong></p>
    <p class="small text-muted mb-2">or click to choose files</p>
    <button type="button" class="btn btn-sm btn-outline-primary">
      Choose files
    </button>
  </div>

  <!-- File list preview -->
  <ul id="fileList" class="small mt-2"></ul>

  <button class="btn btn-sm btn-outline-primary mt-2">
    <i class="fas fa-upload me-1"></i>Upload
  </button>
</form>

  </div>
</div>

</div>
<script>
const dropArea = document.getElementById("dropArea");
const input = document.getElementById("attachmentInput");
const fileList = document.getElementById("fileList");

dropArea.addEventListener("click", () => input.click());

dropArea.addEventListener("dragover", e => {
  e.preventDefault();
  dropArea.classList.add("dragover");
});

dropArea.addEventListener("dragleave", () =>
  dropArea.classList.remove("dragover")
);

dropArea.addEventListener("drop", e => {
  e.preventDefault();
  dropArea.classList.remove("dragover");
  input.files = e.dataTransfer.files;
  renderFiles();
});

input.addEventListener("change", renderFiles);

function renderFiles(){
  fileList.innerHTML = "";
  [...input.files].forEach(f => {
    const li = document.createElement("li");
    li.textContent = `${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
    fileList.appendChild(li);
  });
}
</script>

{% endblock %}
